# 文档指南

## 第 0 步：目录一次性收口（5 分钟）

在 `/docs` 里只保留这 5 类（其它进 Archive）：

* 根：`README.md`（唯一入口）、`TODO.md`（当期目标）
* 文件夹：`/architecture`、`/adr`、`/runbook`、`/archive`（对齐你们现有分类）

在 `/architecture`、`/adr`、`/runbook` 各放一个 `TEMPLATE.md`（模板见下）。

把历史/失败/未启用方案全部移动到 `/archive`，写明“为何归档、由谁取代、现行真源链接”（和你们 legacy-storage 的做法一致）。参考示例：[`storage-refactor-plan-stage5`](https://github.com/sanshanya/OpenAiWriter/blob/f35f4c17d47c0d09eaa61c2ad5f063c5d3e1e00b/docs/archive/legacy-storage/storage-refactor-plan-stage5.md)。

---

## 第 1 步：三条铁律（页首常驻）

1. **真实＞完美**：文档描述当前实现，偏离就先改文档。参考 [`ADR-001`](https://github.com/sanshanya/OpenAiWriter/blob/f35f4c17d47c0d09eaa61c2ad5f063c5d3e1e00b/docs/adr/001-v3-storage-architecture.md)。
2. **单一入口**：新增/改动文档必须能从 `docs/README.md` 点到；触碰存储层要同步 `architecture/storage-overview.md` 并补 ADR。
3. **越少越好**：一页能说明白就别写第二页；历史与长文全部进 Archive。

---

## 第 2 步：模板（复制即写，杜绝走样）

## Front-Matter（所有文档头统一）

<pre class="overflow-visible!" data-start="1181" data-end="1406"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-yaml"><span><span>title:</span><span></span><span><doc-name></span><span>
</span><span>owner:</span><span></span><span>@sans</span><span>
</span><span>status:</span><span></span><span>active</span><span></span><span>|</span><span></span><span>draft</span><span></span><span>|</span><span></span><span>superseded</span><span></span><span>|</span><span></span><span>archived</span><span>
</span><span>updated:</span><span></span><span>2025-10-31</span><span>
</span><span>expires:</span><span></span><span>2025-12-31</span><span></span><span># 到期触发手动“留/删/归档”</span><span>
</span><span>tier:</span><span></span><span>foundational</span><span></span><span>|</span><span></span><span>feature</span><span></span><span>|</span><span></span><span>experimental</span><span>
</span><span>relates:</span><span> [</span><span>ADR-002</span><span>, </span><span>PR#5801</span><span>]
</span></span></code></div></div></pre>

## ADR（/docs/adr/TEMPLATE.md）

<pre class="overflow-visible!" data-start="1438" data-end="1697"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-md"><span><span>---
title: ADR-xxx: <决策>
owner: @sans
status: active
tier: foundational
updated: YYYY-MM-DD
relates: [PR#xxxx]
supersedes: ADR-0xx?
superseded_by: ADR-0yy?
---
## 背景
## 决策
## 后果
- 对开发者的影响：<必须/禁止/约束>   <!-- 强制写清可执行约束，参考存储不变量 ADR-002 -->
## 替代方案（为何不用）
</span></span></code></div></div></pre>

> 参考你们已有的 ADR-002（不变量、单一持久化出口、墓碑优先等）——“对开发者的影响”能直接落到编码约束上[](https://github.com/sanshanya/OpenAiWriter/blob/f35f4c17d47c0d09eaa61c2ad5f063c5d3e1e00b/docs/adr/002-storage-architecture.md)
>
> [002-storage-architecture](https://github.com/sanshanya/OpenAiWriter/blob/f35f4c17d47c0d09eaa61c2ad5f063c5d3e1e00b/docs/adr/002-storage-architecture.md)
>
> 。

## Architecture（/docs/architecture/TEMPLATE.md）

<pre class="overflow-visible!" data-start="1845" data-end="2156"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-md"><span><span>---
title: <模块>-architecture
owner: @sans
status: active
tier: foundational
updated: YYYY-MM-DD
relates: [ADR-0xx, PR#xxxx]
expires: YYYY-MM-DD
---
</span><span>## 边界 & 责任（≤ 5 条）</span><span>
</span><span>## 数据流 / 状态机（1 张 mermaid）</span><span>
</span><span>## 改动触发器（代码路径 → 必须更新本文/ADR）</span><span>
</span><span>-</span><span> 例：/src/lib/storage/** 有“接口/流程变更” ⇒ 更新 storage-overview + 新/修 ADR
</span><span>## 非目标（明确不做什么）</span><span>
</span></span></code></div></div></pre>

> 这页要挂到 docs 索引“核心指南”，并与 TODO/ADR 形成闭环（详见 `docs/README.md`）。

## Runbook（/docs/runbook/TEMPLATE.md）

<pre class="overflow-visible!" data-start="2315" data-end="2525"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-md"><span><span>---
title: <场景>-runbook
owner: @sans
status: active
tier: feature
updated: YYYY-MM-DD
expires: YYYY-MM-DD
---
</span><span>## 目的（1–2 行）</span><span>
</span><span>## 环境（prod/staging、权限）</span><span>
</span><span>## 步骤（≤ 7 步）</span><span>
</span><span>## 回滚（≤ 5 步）</span><span>
</span><span>## 监控/SLO（链接）</span><span>
</span><span>## 常见故障（≤ 5 条）</span><span>
</span></span></code></div></div></pre>

---

## 第 3 步：最小形态与硬限额

* **TODO** ：仅当期目标 + 3~7 个可验收任务（P0/P1/Owner/截止）。超一页就删/分期；`docs/TODO.md` 已承载阶段进度与目标（如 Stage 5 目标与交付）[](https://github.com/sanshanya/OpenAiWriter/blob/f35f4c17d47c0d09eaa61c2ad5f063c5d3e1e00b/docs/TODO.md)
  [TODO](https://github.com/sanshanya/OpenAiWriter/blob/f35f4c17d47c0d09eaa61c2ad5f063c5d3e1e00b/docs/TODO.md)
  。
* **Architecture** ： **1 页 + 1 图** ；增加“改动触发器”指向具体代码目录（如 `/src/lib/storage/**`），强耦合代码与文档更新[](https://github.com/sanshanya/OpenAiWriter/blob/f35f4c17d47c0d09eaa61c2ad5f063c5d3e1e00b/docs/archive/legacy-storage/storage-refactor-plan-stage5.md)
  [storage-refactor-plan-stage5](https://github.com/sanshanya/OpenAiWriter/blob/f35f4c17d47c0d09eaa61c2ad5f063c5d3e1e00b/docs/archive/legacy-storage/storage-refactor-plan-stage5.md)
  。
* **ADR** ：≤ 300 行；必须写“对开发者的影响”（把约束落地到编码层，像 ADR-002 的“单一持久化出口/UI 不触存储”）[](https://github.com/sanshanya/OpenAiWriter/blob/f35f4c17d47c0d09eaa61c2ad5f063c5d3e1e00b/docs/adr/002-storage-architecture.md)
  [002-storage-architecture](https://github.com/sanshanya/OpenAiWriter/blob/f35f4c17d47c0d09eaa61c2ad5f063c5d3e1e00b/docs/adr/002-storage-architecture.md)
  。
* **Archive** ：只放历史/失败/未启用，首段写“为何归档/由谁取代/现行真源链接”（你们 legacy-storage 条目就是范例）[](https://github.com/sanshanya/OpenAiWriter/blob/f35f4c17d47c0d09eaa61c2ad5f063c5d3e1e00b/docs/archive/legacy-storage/storage-refactor-plan-stage5.md)
  [storage-refactor-plan-stage5](https://github.com/sanshanya/OpenAiWriter/blob/f35f4c17d47c0d09eaa61c2ad5f063c5d3e1e00b/docs/archive/legacy-storage/storage-refactor-plan-stage5.md)
  。

---

## 第 4 步：手动流程（无 CI 也能稳）

## A. 创建/修改文档（每次改动 3 步）

1. **从模板复制** （所在目录的 `TEMPLATE.md`）。
2. **补 Front-Matter** （`owner/status/updated/relates/（可选）expires/tier`）。
3. **在 `docs/README.md` 加入链接** （单一入口）。

> 你们的 README 本身就是“Docs Index”，列出了核心指南、项目规划、Archive，以及“触碰存储需更新文档”的约定——新增文档务必挂在这里（参见 `docs/README.md`）。

## B. 合并后 ≤ 10 分钟“结算”

* 更新 `TODO.md`（Done/Owner/PR 号），保持路线图真实（与你们 TODO 的用法一致）[](https://github.com/sanshanya/OpenAiWriter/blob/f35f4c17d47c0d09eaa61c2ad5f063c5d3e1e00b/docs/TODO.md)
  [TODO](https://github.com/sanshanya/OpenAiWriter/blob/f35f4c17d47c0d09eaa61c2ad5f063c5d3e1e00b/docs/TODO.md)
  。
* 若实现与设计偏离： **先改文档** （遵循“真实＞完美”的基本盘）[](https://github.com/sanshanya/OpenAiWriter/blob/f35f4c17d47c0d09eaa61c2ad5f063c5d3e1e00b/docs/adr/001-v3-storage-architecture.md)
  [001-v3-storage-architecture](https://github.com/sanshanya/OpenAiWriter/blob/f35f4c17d47c0d09eaa61c2ad5f063c5d3e1e00b/docs/adr/001-v3-storage-architecture.md)
  。

## C. 每周五 10 分钟“除草”

* 打开 `docs/README.md` 全走一遍，确认所有“活文档”可达。
* 按 **生命周期** 处理到期：Front-Matter 的 `expires` 到期则手动做“留/删/归档”决策，归档时写清“为何归档/由谁取代”。
* 清理“超过两周的 Done”到历史区或 Archive（避免 TODO 长草，详见 README）。

---

# 第 5 步：触发器（这 4 种代码变更必须改文档）

> 写在每个 Architecture 页的“改动触发器”段，同时也体现在 `docs/README.md` 的“约定”里（尤其存储）。
| 代码变更                         | 必改文档                                                                                                                                                                                                                            |
| -------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `/src/lib/storage/**`接口/流程 | `docs/architecture/storage-overview.md`+ 新/修 ADR（例如不变量/Facade 结构）[002-storage-architecture](https://github.com/sanshanya/OpenAiWriter/blob/f35f4c17d47c0d09eaa61c2ad5f063c5d3e1e00b/docs/adr/002-storage-architecture.md) |
| 编辑器骨架/插件管线              | `docs/architecture/editor-architecture.md`、`plugin-workflow.md` 链接在 README 已列。                                                                                                      |
| 运行/上线姿势                    | 相关 Runbook（AI 生产实践/回滚/监控）已在 README 汇总。                                                                                                                                    |
| 阶段目标/路线                    | `docs/TODO.md`（当期 Stage 目标与任务）[TODO](https://github.com/sanshanya/OpenAiWriter/blob/f35f4c17d47c0d09eaa61c2ad5f063c5d3e1e00b/docs/TODO.md)                                                                                  |

---

# 第 6 步：删减规则（小团队的省心术）

 **先删、后归档、再保留** （从严）：

1. **删** ：无人维护、与现状不符、超期（`expires`）却无 Owner 续命的文档。
2. **归档** ：有历史价值的失败/旧案，首段写“为何归档/由谁取代/现行真源链接”[](https://github.com/sanshanya/OpenAiWriter/blob/f35f4c17d47c0d09eaa61c2ad5f063c5d3e1e00b/docs/archive/legacy-storage/storage-refactor-plan-stage5.md)
   [storage-refactor-plan-stage5](https://github.com/sanshanya/OpenAiWriter/blob/f35f4c17d47c0d09eaa61c2ad5f063c5d3e1e00b/docs/archive/legacy-storage/storage-refactor-plan-stage5.md)
   。
3. **保留** ：能指导动作或沉淀硬决策的文档（尤其 TODO、Architecture、关键 ADR）。

---

## 附：三页模板快速拷贝

**`docs/README.md`（索引骨架）**

<pre class="overflow-visible!" data-start="4731" data-end="4983"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-md"><span><span># Docs Index</span><span>
</span><span>## 核心指南</span><span>
</span><span>-</span><span> architecture/storage-overview.md
</span><span>-</span><span> architecture/editor-architecture.md
</span><span>## 项目规划</span><span>
</span><span>-</span><span> TODO.md
</span><span>-</span><span> adr/           # 编号决策
</span><span>## 存档</span><span>
</span><span>-</span><span> archive/       # 历史/失败/被取代
</span><span>> 约定：</span><span>
</span><span>> - 触碰 /src/lib/storage/** 的接口/流程，必须更新 architecture/storage-overview.md 并补 ADR</span><span>
</span></span></code></div></div></pre>

**`docs/TODO.md`（一屏）**

<pre class="overflow-visible!" data-start="5008" data-end="5126"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-md"><span><span># Roadmap (Stage N)</span><span>
</span><span>-</span><span> [P0] 任务 · @owner · 截止(YYYY-MM-DD) · 验收(…)
</span><span>-</span><span> [P1] ...
-- Done(本周) --
</span><span>-</span><span> PR#xxxx: <一句话结果>
</span></span></code></div></div></pre>

**`docs/archive/README.md`（归档约定）**

<pre class="overflow-visible!" data-start="5163" data-end="5241"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-md"><span><span>只接收历史/失败/被取代文档。每篇首段写：
</span><span>-</span><span> 为何归档：…
</span><span>-</span><span> 被谁取代：ADR-xxx / <现行文档链接>
</span><span>-</span><span> 仍有价值：<可选></span></span></code></div></div></pre>


# 收尾：我们的编程与写文档同一哲学

* **安全默认**：只保留必需的类型与出口，其余删掉——类型与常量已收敛到 `types/storage.ts`、`lib/storage/constants.ts`（参见 [`ADR-003`](https://github.com/sanshanya/OpenAiWriter/blob/f35f4c17d47c0d09eaa61c2ad5f063c5d3e1e00b/docs/adr/003-storage-types-unification.md)）。
* **删除即胜利**：未启用/历史方案进 Archive，现行页面保持短、准；legacy-storage 的写法可参考 [`storage-refactor-plan-stage5`](https://github.com/sanshanya/OpenAiWriter/blob/f35f4c17d47c0d09eaa61c2ad5f063c5d3e1e00b/docs/archive/legacy-storage/storage-refactor-plan-stage5.md)。
* **数据第一**：文档服务于“不丢数据、易回滚”，Stage 5 的“少序列化、单一持久化出口”等实践均可在同一示例中找到。

如果需要，我可以把三个模板与 README 骨架按上面内容直接落到你的仓库 `docs/`（不涉及 CI），你只要“复制模板→更新 README → 一周除草”就能稳定运转。

